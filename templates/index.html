<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Normalize Contact</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Contact Normalizer</h1>
      <p class="text-gray-600 mb-8">Upload a CSV file to normalize contacts. We automatically detect and clean phone numbers and emails.</p>

      <!-- CSV Upload Form -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Upload CSV</h2>
        {% if upload_error %}
          <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-700">{{ upload_error }}</div>
        {% endif %}
        <form method="post" action="/normalize_csv" enctype="multipart/form-data" id="csvForm" class="space-y-4">
          <div>
            <label for="csv_file" class="block text-sm font-medium text-gray-700 mb-1">CSV file</label>
            <input id="csv_file" name="csv_file" type="file" accept=".csv,text/csv" 
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          </div>
          <div>
            <label for="default_region_csv" class="block text-sm font-medium text-gray-700 mb-1">Default Region</label>
            <select id="default_region_csv" name="default_region" 
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="US" selected>US/Canada (adds +1 if 10 digits)</option>
              <option value="INTL">International (no special assumptions)</option>
            </select>
          </div>
          <input type="hidden" name="preview_only" value="true" />
          <button type="submit" 
            class="w-full bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
            Process CSV
          </button>
        </form>
      </div>

      <!-- Cleaned Output -->
      {% if csv_output %}
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-800">Cleaned Output</h2>
            <a href="/download_cleaned" 
              class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors text-sm">
              Download Cleaned
            </a>
          </div>
          <p class="text-sm text-gray-500 mb-4">Showing {{ csv_output.rows|length }} of {{ csv_output.total_rows }} rows</p>
          <div class="overflow-x-auto border border-gray-200 rounded-md">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  {% for header in csv_output.headers %}
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">{{ header }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                {% for row in csv_output.rows %}
                <tr class="hover:bg-gray-50">
                  {% for header in csv_output.headers %}
                  <td class="px-3 py-2 text-sm text-gray-700 whitespace-nowrap">
                    {% if header == "email_valid" or header == "phone_valid" %}
                      {% if row.get(header, '').lower() == "true" %}
                        <span class="text-green-600 font-medium">âœ“</span>
                      {% else %}
                        <span class="text-red-600 font-medium">âœ—</span>
                      {% endif %}
                    {% elif header == "email_normalized" or header == "phone_normalized" %}
                      <span class="{% if row.get(header.replace('_normalized', '_valid'), '').lower() == 'true' %}text-green-600 font-medium{% else %}text-gray-500{% endif %}">
                        {{ row.get(header, '') }}
                      </span>
                    {% else %}
                      {{ row.get(header, '') }}
                    {% endif %}
                  </td>
                  {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
      </div>

      <!-- Send Emails Button -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <button id="sendEmailsBtn" 
          class="w-full bg-purple-600 text-white px-6 py-3 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-colors font-medium">
          ðŸ“§ Send Emails to All Valid Recipients (Mock)
        </button>
        <div id="emailStatus" class="mt-4 hidden"></div>
      </div>
      {% endif %}
    </div>

    <script>
      // Handle email sending
      document.getElementById('sendEmailsBtn')?.addEventListener('click', async function() {
        const btn = this;
        const statusDiv = document.getElementById('emailStatus');
        
        btn.disabled = true;
        btn.textContent = 'Sending...';
        statusDiv.classList.add('hidden');
        
        try {
          const response = await fetch('/send_emails', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            }
          });
          
          const data = await response.json();
          
          if (data.success) {
            statusDiv.className = 'mt-4 p-4 bg-green-50 border border-green-200 rounded-md text-green-700';
            statusDiv.textContent = data.message;
            statusDiv.classList.remove('hidden');
          } else {
            throw new Error(data.message || 'Failed to send emails');
          }
        } catch (error) {
          statusDiv.className = 'mt-4 p-4 bg-red-50 border border-red-200 rounded-md text-red-700';
          statusDiv.textContent = 'Error: ' + error.message;
          statusDiv.classList.remove('hidden');
        } finally {
          btn.disabled = false;
          btn.textContent = 'ðŸ“§ Send Emails to All Valid Recipients (Mock)';
        }
      });
    </script>
  </body>
</html>
